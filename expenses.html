<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses - Tour Management</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .page-title h1 {
            color: white;
            margin-bottom: 5px;
        }
        
        .page-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stats-banner {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-box i {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-box h3 {
            font-size: 28px;
            margin: 10px 0 5px 0;
            color: #1f2937;
        }
        
        .stat-box p {
            color: #6b7280;
            font-size: 14px;
        }
        
        .expense-form-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .section-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .section-header h3 {
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .section-header p {
            color: #6b7280;
            font-size: 14px;
        }
        
        .expense-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .expense-summary {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f59e0b;
        }
        
        .expense-summary h4 {
            color: #92400e;
            margin-bottom: 10px;
        }
        
        .expenses-list-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .expense-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #f59e0b;
            transition: all 0.3s ease;
        }
        
        .expense-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }
        
        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .expense-title {
            font-weight: bold;
            color: #1f2937;
            font-size: 18px;
        }
        
        .expense-amount {
            background: #f59e0b;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .expense-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            font-size: 14px;
            color: #4b5563;
        }
        
        .expense-detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .expense-detail-item i {
            color: #6b7280;
            width: 16px;
        }
        
        .category-badge {
            background: #e5e7eb;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .pdf-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .pdf-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .pdf-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .pdf-info {
            background: #fef2f2;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ef4444;
        }
        
        .pdf-info h5 {
            color: #991b1b;
            margin-bottom: 8px;
        }
        
        .pdf-info ul {
            color: #7f1d1d;
            font-size: 14px;
            margin: 0;
            padding-left: 20px;
        }
        
        .balance-indicator {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #0ea5e9;
        }
        
        .balance-positive {
            background: #f0fdf4;
            border-left-color: #10b981;
        }
        
        .balance-negative {
            background: #fef2f2;
            border-left-color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <h1><i class="fas fa-receipt"></i> Expense Management</h1>
                <p>Track and manage your trip expenses</p>
            </div>
            <div class="page-actions">
                <a href="index.html" class="btn" style="background: white; color: #f59e0b; text-decoration: none;">
                    <i class="fas fa-home"></i> Back to Home
                </a>
                <a href="dashboard.html" class="btn" style="background: rgba(255,255,255,0.2); color: white; text-decoration: none;">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
            </div>
        </div>

        <!-- Statistics Banner -->
        <div class="stats-banner">
            <div class="stat-box">
                <i class="fas fa-receipt"></i>
                <h3 id="totalExpensesCount">0</h3>
                <p>Total Expenses</p>
            </div>
            <div class="stat-box">
                <i class="fas fa-rupee-sign"></i>
                <h3 id="totalExpensesAmount">‚Çπ0</h3>
                <p>Total Amount</p>
            </div>
            <div class="stat-box">
                <i class="fas fa-hand-holding-usd"></i>
                <h3 id="totalContributionsAmount">‚Çπ0</h3>
                <p>Total Contributions</p>
            </div>
            <div class="stat-box">
                <i class="fas fa-balance-scale"></i>
                <h3 id="balanceAmount">‚Çπ0</h3>
                <p>Balance</p>
            </div>
        </div>

        <!-- Expense Form Section -->
        <div class="expense-form-section">
            <div class="section-header">
                <h3><i class="fas fa-plus-circle"></i> Add New Expense</h3>
                <p>Record expenses incurred during your trip</p>
            </div>
            
            <form id="expenseForm">
                <div class="expense-form-grid">
                    <div class="form-group">
                        <label for="expenseCategory">Category *</label>
                        <select id="expenseCategory" required>
                            <option value="">-- Select Category --</option>
                            <option value="Food & Drinks">üçΩÔ∏è Food & Drinks</option>
                            <option value="Accommodation">üè® Accommodation</option>
                            <option value="Transport">üöó Transport</option>
                            <option value="Fuel Refill">‚õΩ Fuel Refill</option>
                            <option value="Fuel Purchase">üõ¢Ô∏è Fuel Purchase</option>
                            <option value="Diesel">‚õΩ Diesel</option>
                            <option value="Petrol">‚õΩ Petrol</option>
                            <option value="Tolls">üõ£Ô∏è Tolls</option>
                            <option value="Parking">üÖøÔ∏è Parking</option>
                            <option value="Activities">üéØ Activities</option>
                            <option value="Shopping">üõçÔ∏è Shopping</option>
                            <option value="Medical">üè• Medical</option>
                            <option value="Other">üìã Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseDescription">Description *</label>
                        <input type="text" id="expenseDescription" placeholder="e.g., Lunch at restaurant" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseAmount">Amount (‚Çπ) *</label>
                        <input type="number" id="expenseAmount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseDate">Date *</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseLocation">Location (Optional)</label>
                        <input type="text" id="expenseLocation" placeholder="e.g., Mumbai, Hotel XYZ">
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseNotes">Notes (Optional)</label>
                        <input type="text" id="expenseNotes" placeholder="Additional details">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-plus"></i> Add Expense
                </button>
            </form>
            
            <div id="expenseSummary" class="expense-summary" style="display: none;">
                <!-- Expense summary will be displayed here -->
            </div>
        </div>

        <!-- Expenses List Section -->
        <div class="expenses-list-section">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> Expense Records</h3>
                <p>View and manage all recorded expenses</p>
            </div>
            
            <div id="expensesList" class="expenses-list">
                <!-- Expenses will be displayed here -->
            </div>
        </div>

        <!-- PDF Report Section -->
        <div class="pdf-section">
            <div class="section-header">
                <h3><i class="fas fa-file-pdf"></i> Generate PDF Report</h3>
                <p>Create a comprehensive expense report</p>
            </div>
            
            <button id="generatePdfReport" class="pdf-button">
                <i class="fas fa-file-pdf"></i>
                Generate Complete Trip Report (PDF)
            </button>
            
            <div class="pdf-info">
                <h5><i class="fas fa-info-circle"></i> Report includes:</h5>
                <ul>
                    <li>Driver information and vehicle details</li>
                    <li>Complete expense breakdown by category</li>
                    <li>Family member contributions</li>
                    <li>Route information and stops</li>
                    <li>Diesel consumption and costs</li>
                    <li>Financial summary and balance</li>
                </ul>
            </div>
            
            <div id="balanceIndicator" class="balance-indicator" style="display: none;">
                <!-- Balance information will be displayed here -->
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Supabase Configuration -->
    <script type="module" src="supabase-config.js"></script>
    
    <!-- Page Script -->
    <script>
        // Data Storage
        let tourData = {
            driver: {},
            dieselRecords: [],
            familyMembers: [],
            contributions: [],
            route: {},
            stops: [],
            expenses: [],
            locationHistory: []
        };

        // Load data
        async function loadData() {
            try {
                if (window.loadFromSupabase) {
                    const cloudData = await window.loadFromSupabase();
                    if (cloudData) {
                        tourData = cloudData;
                        localStorage.setItem('tourManagementData', JSON.stringify(tourData));
                        return;
                    }
                }
                
                const savedData = localStorage.getItem('tourManagementData');
                if (savedData) {
                    tourData = JSON.parse(savedData);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                const savedData = localStorage.getItem('tourManagementData');
                if (savedData) {
                    tourData = JSON.parse(savedData);
                }
            }
        }

        // Save data
        async function saveData() {
            try {
                localStorage.setItem('tourManagementData', JSON.stringify(tourData));
                
                if (window.saveToSupabase) {
                    await window.saveToSupabase(tourData);
                }
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Update statistics
        function updateStatistics() {
            // Total expenses
            const expensesCount = (tourData.expenses || []).length;
            document.getElementById('totalExpensesCount').textContent = expensesCount;

            // Total expenses amount
            const totalExpenses = (tourData.expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('totalExpensesAmount').textContent = '‚Çπ' + totalExpenses.toFixed(2);

            // Total contributions
            const totalContributions = (tourData.contributions || []).reduce((sum, c) => sum + c.amount, 0);
            document.getElementById('totalContributionsAmount').textContent = '‚Çπ' + totalContributions.toFixed(2);

            // Balance
            const balance = totalContributions - totalExpenses;
            const balanceElement = document.getElementById('balanceAmount');
            balanceElement.textContent = '‚Çπ' + Math.abs(balance).toFixed(2);
            
            if (balance >= 0) {
                balanceElement.style.color = '#10b981';
            } else {
                balanceElement.style.color = '#ef4444';
            }

            // Update balance indicator
            updateBalanceIndicator(balance);
        }

        // Update balance indicator
        function updateBalanceIndicator(balance) {
            const indicator = document.getElementById('balanceIndicator');
            
            if (tourData.expenses.length === 0 && tourData.contributions.length === 0) {
                indicator.style.display = 'none';
                return;
            }

            indicator.style.display = 'block';
            
            if (balance >= 0) {
                indicator.className = 'balance-indicator balance-positive';
                indicator.innerHTML = `
                    <h5 style="color: #065f46;"><i class="fas fa-check-circle"></i> Positive Balance</h5>
                    <p style="color: #047857;">You have ‚Çπ${balance.toFixed(2)} remaining from contributions. Total contributions cover all expenses with surplus.</p>
                `;
            } else {
                indicator.className = 'balance-indicator balance-negative';
                indicator.innerHTML = `
                    <h5 style="color: #991b1b;"><i class="fas fa-exclamation-triangle"></i> Negative Balance</h5>
                    <p style="color: #7f1d1d;">Expenses exceed contributions by ‚Çπ${Math.abs(balance).toFixed(2)}. Additional contributions needed.</p>
                `;
            }
        }

        // Update expense summary
        function updateExpenseSummary() {
            const summaryDiv = document.getElementById('expenseSummary');
            
            if (!tourData.expenses || tourData.expenses.length === 0) {
                summaryDiv.style.display = 'none';
                return;
            }

            summaryDiv.style.display = 'block';
            
            const totalAmount = tourData.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const categoryBreakdown = {};
            
            tourData.expenses.forEach(expense => {
                if (!categoryBreakdown[expense.category]) {
                    categoryBreakdown[expense.category] = 0;
                }
                categoryBreakdown[expense.category] += expense.amount;
            });

            let html = `
                <h4><i class="fas fa-chart-pie"></i> Expense Summary</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px; margin-bottom: 15px;">
                    <div><strong>Total Expenses:</strong> ‚Çπ${totalAmount.toFixed(2)}</div>
                    <div><strong>Total Records:</strong> ${tourData.expenses.length}</div>
                    <div><strong>Categories:</strong> ${Object.keys(categoryBreakdown).length}</div>
                </div>
            `;

            if (Object.keys(categoryBreakdown).length > 0) {
                html += `
                    <div>
                        <strong>Breakdown by Category:</strong>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            ${Object.entries(categoryBreakdown)
                                .sort(([,a], [,b]) => b - a)
                                .map(([category, amount]) => `
                                    <div class="category-badge" style="display: flex; justify-content: space-between;">
                                        <span>${category}</span>
                                        <span>‚Çπ${amount.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                `;
            }

            summaryDiv.innerHTML = html;
        }

        // Display expenses
        function displayExpenses() {
            const container = document.getElementById('expensesList');
            
            if (!tourData.expenses || tourData.expenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <h3>No expenses recorded yet</h3>
                        <p>Add your first expense using the form above</p>
                    </div>
                `;
                return;
            }

            // Sort expenses by date (newest first)
            const sortedExpenses = [...tourData.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = '';
            sortedExpenses.forEach((expense, index) => {
                html += `
                    <div class="expense-item">
                        <div class="expense-header">
                            <div class="expense-title">
                                <i class="fas fa-receipt"></i> ${expense.description}
                            </div>
                            <div class="expense-amount">‚Çπ${expense.amount.toFixed(2)}</div>
                        </div>
                        <div class="expense-details">
                            <div class="expense-detail-item">
                                <i class="fas fa-tag"></i>
                                <span>${expense.category}</span>
                            </div>
                            <div class="expense-detail-item">
                                <i class="fas fa-calendar"></i>
                                <span>${new Date(expense.date).toLocaleDateString()}</span>
                            </div>
                            ${expense.location ? `
                                <div class="expense-detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${expense.location}</span>
                                </div>
                            ` : ''}
                            ${expense.notes ? `
                                <div class="expense-detail-item">
                                    <i class="fas fa-sticky-note"></i>
                                    <span>${expense.notes}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Initialize expense form
        function initExpenseForm() {
            const form = document.getElementById('expenseForm');
            
            // Set default date to today
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const expense = {
                    category: document.getElementById('expenseCategory').value,
                    description: document.getElementById('expenseDescription').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    date: document.getElementById('expenseDate').value,
                    location: document.getElementById('expenseLocation').value,
                    notes: document.getElementById('expenseNotes').value,
                    timestamp: new Date().toISOString()
                };
                
                if (!tourData.expenses) tourData.expenses = [];
                tourData.expenses.push(expense);
                
                saveData();
                updateStatistics();
                updateExpenseSummary();
                displayExpenses();
                
                // Clear form
                form.reset();
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                
                showNotification(`Expense "${expense.description}" added successfully!`, 'success');
            });
        }

        // Generate PDF report
        function generateTripPdfReport() {
            if (!window.jspdf) {
                showNotification('PDF library not loaded. Please refresh the page.', 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Title
            doc.setFontSize(20);
            doc.setTextColor(0, 0, 0);
            doc.text('Trip Expense Report', 105, 20, { align: 'center' });

            // Date
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            let yPosition = 45;

            // Driver Information
            if (tourData.driver && tourData.driver.name) {
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Driver Information', 20, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                doc.text(`Name: ${tourData.driver.name || 'N/A'}`, 20, yPosition);
                yPosition += 6;
                doc.text(`Mobile: ${tourData.driver.mobile || 'N/A'}`, 20, yPosition);
                yPosition += 6;
                doc.text(`Car Number: ${tourData.driver.carNumber || 'N/A'}`, 20, yPosition);
                yPosition += 6;
                doc.text(`Kilometer Reading: ${tourData.driver.kilometerReading || 'N/A'}`, 20, yPosition);
                yPosition += 6;
                doc.text(`Diesel Available: ${tourData.driver.dieselAvailable || 'N/A'}`, 20, yPosition);
                yPosition += 15;
            }

            // Route Information
            if (tourData.route && tourData.route.startPointName) {
                doc.setFontSize(14);
                doc.text('Route Information', 20, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                doc.text(`From: ${tourData.route.startPointName}`, 20, yPosition);
                yPosition += 6;
                doc.text(`To: ${tourData.route.endPointName}`, 20, yPosition);
                yPosition += 6;
                doc.text(`Stops: ${(tourData.stops || []).length}`, 20, yPosition);
                yPosition += 15;
            }

            // Family Members and Contributions
            const totalContributions = (tourData.contributions || []).reduce((sum, c) => sum + c.amount, 0);
            if (tourData.familyMembers && tourData.familyMembers.length > 0) {
                doc.setFontSize(14);
                doc.text('Family Members & Contributions', 20, yPosition);
                yPosition += 10;

                // Create table for family members
                const familyData = tourData.familyMembers.map(member => {
                    const memberContributions = (tourData.contributions || [])
                        .filter(c => c.member === member.name)
                        .reduce((sum, c) => sum + c.amount, 0);
                    
                    return [
                        member.name || 'N/A',
                        member.mobile || 'N/A',
                        `‚Çπ${memberContributions.toFixed(2)}`
                    ];
                });

                doc.autoTable({
                    startY: yPosition,
                    head: [['Name', 'Mobile', 'Contribution']],
                    body: familyData,
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [245, 158, 11] }
                });

                yPosition = doc.lastAutoTable.finalY + 10;
                doc.text(`Total Contributions: ‚Çπ${totalContributions.toFixed(2)}`, 20, yPosition);
                yPosition += 15;
            }

            // Expense Breakdown
            const totalExpenses = (tourData.expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
            if (tourData.expenses && tourData.expenses.length > 0) {
                doc.setFontSize(14);
                doc.text('Expense Breakdown', 20, yPosition);
                yPosition += 10;

                // Create expense table
                const expenseData = tourData.expenses.map(expense => [
                    expense.category,
                    expense.description,
                    `‚Çπ${expense.amount.toFixed(2)}`,
                    new Date(expense.date).toLocaleDateString()
                ]);

                doc.autoTable({
                    startY: yPosition,
                    head: [['Category', 'Description', 'Amount', 'Date']],
                    body: expenseData,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [245, 158, 11] }
                });

                yPosition = doc.lastAutoTable.finalY + 10;
                doc.text(`Total Expenses: ‚Çπ${totalExpenses.toFixed(2)}`, 20, yPosition);
                yPosition += 15;
            }

            // Diesel Records
            if (tourData.dieselRecords && tourData.dieselRecords.length > 0) {
                doc.setFontSize(14);
                doc.text('Diesel Consumption', 20, yPosition);
                yPosition += 10;

                const dieselData = tourData.dieselRecords.map(record => [
                    new Date(record.date).toLocaleDateString(),
                    `${record.liters} L`,
                    `‚Çπ${record.cost.toFixed(2)}`,
                    record.location || 'N/A'
                ]);

                doc.autoTable({
                    startY: yPosition,
                    head: [['Date', 'Liters', 'Cost', 'Location']],
                    body: dieselData,
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [245, 158, 11] }
                });

                yPosition = doc.lastAutoTable.finalY + 10;
                
                const totalDieselCost = tourData.dieselRecords.reduce((sum, r) => sum + r.cost, 0);
                const totalDieselLiters = tourData.dieselRecords.reduce((sum, r) => sum + r.liters, 0);
                doc.text(`Total Diesel: ${totalDieselLiters.toFixed(2)} L (‚Çπ${totalDieselCost.toFixed(2)})`, 20, yPosition);
                yPosition += 15;
            }

            // Financial Summary
            doc.setFontSize(14);
            doc.text('Financial Summary', 20, yPosition);
            yPosition += 10;

            const balance = totalContributions - totalExpenses;
            doc.setFontSize(10);
            doc.text(`Total Contributions: ‚Çπ${totalContributions.toFixed(2)}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Total Expenses: ‚Çπ${totalExpenses.toFixed(2)}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Balance: ‚Çπ${balance.toFixed(2)} ${balance >= 0 ? '(Surplus)' : '(Deficit)'}`, 20, yPosition);

            // Save the PDF
            doc.save(`trip-expense-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('PDF report generated successfully!', 'success');
        }

        // Initialize PDF button
        function initPdfReport() {
            document.getElementById('generatePdfReport').addEventListener('click', generateTripPdfReport);
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                max-width: 300px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = '#10b981';
                    break;
                case 'error':
                    notification.style.background = '#ef4444';
                    break;
                case 'warning':
                    notification.style.background = '#f59e0b';
                    break;
                default:
                    notification.style.background = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadData();
            
            initExpenseForm();
            initPdfReport();
            
            updateStatistics();
            updateExpenseSummary();
            displayExpenses();
        });
    </script>
</body>
</html>
